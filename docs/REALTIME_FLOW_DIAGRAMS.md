# Real-Time Collaborative Editing - System Flow Diagrams

## 1. Initial Connection Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User 1  â”‚                                      â”‚ User 2  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚                                                â”‚
     â”‚ 1. Navigate to /branch/1                      â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
     â”‚                                  â”‚            â”‚
     â”‚                                  â–¼            â”‚
     â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
     â”‚                         â”‚  Next.js Page    â”‚  â”‚
     â”‚                         â”‚  (Server)        â”‚  â”‚
     â”‚                         â”‚  - Fetch cases   â”‚  â”‚
     â”‚                         â”‚  - Auth check    â”‚  â”‚
     â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
     â”‚                                  â”‚            â”‚
     â”‚ 2. Render with SSE hook          â”‚            â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
     â”‚                                                â”‚
     â”‚ 3. Connect to SSE                              â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
     â”‚  GET /api/sse/warranty-  â”‚                    â”‚
     â”‚  updates?branchId=1      â”‚                    â”‚
     â”‚                          â”‚                    â”‚
     â”‚                          â–¼                    â”‚
     â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
     â”‚                    â”‚ SSE Manager  â”‚           â”‚
     â”‚                    â”‚ - Add conn   â”‚           â”‚
     â”‚                    â”‚ - Auth check â”‚           â”‚
     â”‚                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
     â”‚                           â”‚                   â”‚
     â”‚ 4. Connection confirmed   â”‚                   â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
     â”‚ data: {"type":"connection-                    â”‚
     â”‚        established"}                           â”‚
     â”‚                                                â”‚
     â”‚ 5. UI shows green indicator                   â”‚
     â”‚                                                â”‚
     â”‚                                                â”‚ 6. User 2 also connects
     â”‚                                                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                                                â”‚                     â”‚
     â”‚                                                â”‚                     â–¼
     â”‚                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      (Same flow
     â”‚                                          â”‚ SSE Manager  â”‚       as User 1)
     â”‚                                          â”‚ - Add conn   â”‚
     â”‚                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 2. Field Edit Flow (Happy Path)

```
User 1 Edits Field:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User 1  â”‚                                      â”‚ User 2  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚                                                â”‚
     â”‚ 1. Click "Customer Name"                       â”‚ (Viewing)
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
     â”‚ acquireFieldLock()       â”‚                    â”‚
     â”‚                          â”‚                    â”‚
     â”‚                          â–¼                    â”‚
     â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
     â”‚                    â”‚ Lock Manager â”‚           â”‚
     â”‚                    â”‚ - Check lock â”‚           â”‚
     â”‚                    â”‚ - Acquire    â”‚           â”‚
     â”‚                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
     â”‚                           â”‚                   â”‚
     â”‚ 2. Lock acquired          â”‚ 3. Broadcast      â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                                                â”‚
     â”‚ 4. Show input field                           â”‚ 4. Show lock icon ğŸ”’
     â”‚ [John Smith_]                                  â”‚ "Locked by User 1"
     â”‚                                                â”‚
     â”‚ 5. User types "..."                            â”‚
     â”‚ (Debounced 1 second)                           â”‚
     â”‚                                                â”‚
     â”‚ 6. After 1 sec, save                           â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
     â”‚ updateWarrantyCase()     â”‚                    â”‚
     â”‚                          â”‚                    â”‚
     â”‚                          â–¼                    â”‚
     â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
     â”‚                    â”‚  Database    â”‚           â”‚
     â”‚                    â”‚  - Update    â”‚           â”‚
     â”‚                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
     â”‚                           â”‚                   â”‚
     â”‚                           â–¼                   â”‚
     â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
     â”‚                    â”‚ SSE Broadcastâ”‚           â”‚
     â”‚                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
     â”‚                           â”‚                   â”‚
     â”‚ 7. Success               â”‚ 8. Update          â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                                                â”‚
     â”‚                                                â”‚ 9. UI updates
     â”‚                                                â”‚ "John Smith"
     â”‚                                                â”‚ (without disruption)
     â”‚ 10. Click away                                 â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
     â”‚ releaseFieldLock()       â”‚                    â”‚
     â”‚                          â–¼                    â”‚
     â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
     â”‚                    â”‚ Lock Manager â”‚           â”‚
     â”‚                    â”‚ - Release    â”‚           â”‚
     â”‚                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
     â”‚                           â”‚ 11. Broadcast     â”‚
     â”‚                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                                                â”‚
     â”‚                                                â”‚ 12. Remove lock icon
     â”‚                                                â”‚ Field now editable
```

## 3. Concurrent Edit Attempt (Lock Prevents)

```
User 2 Tries to Edit Locked Field:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User 1  â”‚                                      â”‚ User 2  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚                                                â”‚
     â”‚ 1. Editing "Customer Name"                     â”‚
     â”‚ [John Smith_]                                  â”‚
     â”‚ (Lock active)                                  â”‚
     â”‚                                                â”‚
     â”‚                                                â”‚ 2. Clicks same field
     â”‚                                                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                                                â”‚ acquireFieldLock()
     â”‚                                                â”‚                 â”‚
     â”‚                                                â”‚                 â–¼
     â”‚                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                                          â”‚ Lock Manager â”‚
     â”‚                                          â”‚ - Check lock â”‚
     â”‚                                          â”‚ - Denied âŒ  â”‚
     â”‚                                          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                                                â”‚
     â”‚                                                â”‚ 3. Lock denied
     â”‚                                                â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                                                â”‚
     â”‚                                                â”‚ 4. Show toast
     â”‚                                                â”‚ âš ï¸ "Field is being
     â”‚                                                â”‚    edited by User 1"
     â”‚                                                â”‚
     â”‚                                                â”‚ 5. Cannot edit
     â”‚ 6. User 1 finishes                             â”‚ ğŸ”’ "Locked by User 1"
     â”‚ (Click away)                                   â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
     â”‚ releaseFieldLock()       â”‚                    â”‚
     â”‚                          â–¼                    â”‚
     â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
     â”‚                    â”‚ Lock Manager â”‚           â”‚
     â”‚                    â”‚ - Release    â”‚           â”‚
     â”‚                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
     â”‚                           â”‚ 7. Broadcast      â”‚
     â”‚                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                                                â”‚
     â”‚                                                â”‚ 8. Lock removed
     â”‚                                                â”‚ âœ… Now editable
```

## 4. Connection Loss & Recovery

```
User Loses Connection:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚
     â”‚ 1. Connected (ğŸŸ¢)
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€SSE Connectionâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ Server
     â”‚                                           â”‚
     â”‚ 2. Internet drops âŒ                      â”‚
     â”‚                                           â”‚
     â”‚ âœ—âœ—âœ—âœ—âœ—âœ—âœ—âœ—âœ—âœ—âœ—âœ—âœ—âœ—âœ—âœ—âœ—âœ—âœ—âœ—                   â”‚
     â”‚                                           â”‚ 3. Connection closed
     â”‚ 4. Indicator: ğŸŸ¡ "Reconnecting..."       â”‚ 4. Remove from manager
     â”‚                                           â”‚ 5. Release all locks
     â”‚ 5. Attempt 1 (1s delay)                  â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€âœ—âœ—âœ—âœ—âœ—âœ—âœ—âœ—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                                           â”‚
     â”‚ 6. Attempt 2 (2s delay)                  â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€âœ—âœ—âœ—âœ—âœ—âœ—âœ—âœ—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                                           â”‚
     â”‚ 7. Attempt 3 (4s delay)                  â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€âœ—âœ—âœ—âœ—âœ—âœ—âœ—âœ—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                                           â”‚
     â”‚ 8. Internet restored âœ…                   â”‚
     â”‚                                           â”‚
     â”‚ 9. Attempt 4 (8s delay) - Success!       â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€SSE Connectionâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                                           â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€Connection OKâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                           â”‚
     â”‚ 10. Indicator: ğŸŸ¢ "Connected"            â”‚
     â”‚                                           â”‚
     â”‚ 11. Full sync triggered                   â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€syncWithServer()â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                                           â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€Fresh Dataâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                           â”‚
     â”‚ 12. UI updated (without disruption)       â”‚
```

## 5. Debouncing in Action

```
User Types Rapidly:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User   â”‚                                      â”‚  Server  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                                                â”‚
     â”‚ 1. Types "J"                                   â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
     â”‚ Start timer (1000ms)     â”‚                    â”‚
     â”‚                          â”‚                    â”‚
     â”‚ 2. Types "o" (100ms later)                    â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
     â”‚ Cancel prev, new timer   â”‚                    â”‚
     â”‚                          â”‚                    â”‚
     â”‚ 3. Types "h" (100ms later)                    â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
     â”‚ Cancel prev, new timer   â”‚                    â”‚
     â”‚                          â”‚                    â”‚
     â”‚ 4. Types "n" (100ms later)                    â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
     â”‚ Cancel prev, new timer   â”‚                    â”‚
     â”‚                          â”‚                    â”‚
     â”‚ 5. Stops typing                               â”‚
     â”‚                          â”‚                    â”‚
     â”‚ 6. Wait 1000ms...        â”‚                    â”‚
     â”‚                          â”‚                    â”‚
     â”‚ 7. Timer fires           â”‚                    â”‚
     â”‚                          â–¼                    â”‚
     â”‚                    Save "John"                â”‚
     â”‚                          â”‚                    â”‚
     â”‚ 8. Single server call    â”‚                    â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                                                â”‚
     â”‚                                                â”‚ 9. Update DB
     â”‚                                                â”‚ (1 query instead of 4)
     â”‚                                                â”‚
     â”‚ 10. Success + Broadcast   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                                â”‚

Result: 75% reduction in database queries!
```

## 6. Data Flow Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Client Browser                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  Component Layer                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ WarrantyCaseTableWrapper                           â”‚    â”‚
â”‚  â”‚  â”œâ”€ Connection Status Indicator                    â”‚    â”‚
â”‚  â”‚  â””â”€ WarrantyCaseTable                              â”‚    â”‚
â”‚  â”‚      â”œâ”€ EditableTextCell (lock aware)              â”‚    â”‚
â”‚  â”‚      â””â”€ DropdownCell (lock aware)                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                          â†•ï¸                                  â”‚
â”‚  State Layer                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ CollaborativeEditingStore (Zustand)                â”‚    â”‚
â”‚  â”‚  â”œâ”€ fieldLocks: Map<string, FieldLock>            â”‚    â”‚
â”‚  â”‚  â”œâ”€ editingFields: Map<string, {caseId, field}>   â”‚    â”‚
â”‚  â”‚  â”œâ”€ pendingUpdates: Map<string, PendingUpdate>    â”‚    â”‚
â”‚  â”‚  â”œâ”€ optimisticUpdates: Map<number, Updates>       â”‚    â”‚
â”‚  â”‚  â””â”€ serverData: Map<number, Case>                 â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                          â†•ï¸                                  â”‚
â”‚  Hook Layer                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ useRealtimeUpdates()                               â”‚    â”‚
â”‚  â”‚  â”œâ”€ SSE Connection Management                      â”‚    â”‚
â”‚  â”‚  â”œâ”€ Auto-Reconnection                              â”‚    â”‚
â”‚  â”‚  â”œâ”€ Message Processing                             â”‚    â”‚
â”‚  â”‚  â””â”€ Periodic Sync                                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                          â†•ï¸                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†•ï¸
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Next.js Server                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  API Route                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ /api/sse/warranty-updates                          â”‚    â”‚
â”‚  â”‚  â”œâ”€ Authenticate user (Clerk)                      â”‚    â”‚
â”‚  â”‚  â”œâ”€ Create SSE stream                              â”‚    â”‚
â”‚  â”‚  â”œâ”€ Register with SSEManager                       â”‚    â”‚
â”‚  â”‚  â””â”€ Send heartbeats                                â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                          â†•ï¸                                  â”‚
â”‚  Connection Manager                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ SSEConnectionManager (Singleton)                   â”‚    â”‚
â”‚  â”‚  â”œâ”€ connections: Map<userId, Connection>          â”‚    â”‚
â”‚  â”‚  â”œâ”€ fieldLocks: Map<key, FieldLock>               â”‚    â”‚
â”‚  â”‚  â”œâ”€ broadcast(): Send to all users                â”‚    â”‚
â”‚  â”‚  â”œâ”€ acquireFieldLock(): Lock management           â”‚    â”‚
â”‚  â”‚  â””â”€ Auto-cleanup: Expired locks                   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                          â†•ï¸                                  â”‚
â”‚  Server Actions                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ updateWarrantyCase()                               â”‚    â”‚
â”‚  â”‚  â”œâ”€ Update database                                â”‚    â”‚
â”‚  â”‚  â”œâ”€ Broadcast to SSEManager                        â”‚    â”‚
â”‚  â”‚  â””â”€ Revalidate path                                â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                          â†•ï¸                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†•ï¸
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Database (MySQL)                         â”‚
â”‚                    via Prisma ORM                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 7. Message Types Flow

```
Server â†’ Client Messages:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

connection-established
â”œâ”€ When: Client connects
â”œâ”€ Data: { userId, branchId }
â””â”€ Action: Set connected status

field-locked
â”œâ”€ When: Another user starts editing
â”œâ”€ Data: { caseId, field, userId, userName, expiresAt }
â””â”€ Action: Show lock icon, disable field

field-unlocked
â”œâ”€ When: User stops editing
â”œâ”€ Data: { caseId, field, userId }
â””â”€ Action: Remove lock icon, enable field

case-updated
â”œâ”€ When: Another user saves
â”œâ”€ Data: { caseId, updates: { field: value } }
â””â”€ Action: Update UI (skip editing fields)

sync-required
â”œâ”€ When: Conflict detected
â”œâ”€ Data: { caseId }
â””â”€ Action: Fetch fresh data from server

heartbeat
â”œâ”€ When: Every 30 seconds
â”œâ”€ Data: { timestamp }
â””â”€ Action: Keep connection alive
```

## 8. Lock Lifecycle

```
Lock Lifecycle:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[Create]
   â”‚
   â”‚ acquireFieldLock(caseId, field)
   â”‚
   â–¼
[Active] â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚                   â”‚ refreshFieldLock()
   â”‚ expires_in: 30s   â”‚ (optional, extends)
   â”‚                   â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º User edits field
   â”‚
   â”‚ User stops editing
   â”‚ OR
   â”‚ User disconnects
   â”‚ OR
   â”‚ 30 seconds pass
   â”‚
   â–¼
[Release]
   â”‚
   â”‚ releaseFieldLock(caseId, field)
   â”‚ OR auto-cleanup
   â”‚
   â–¼
[Deleted]
```

## Summary

These diagrams illustrate:

1. **Initial Connection**: How users connect to SSE
2. **Field Edit Flow**: Complete edit cycle with locks
3. **Concurrent Edit**: How locks prevent conflicts
4. **Connection Loss**: Auto-reconnection mechanism
5. **Debouncing**: How rapid typing is batched
6. **Data Flow**: System architecture layers
7. **Messages**: SSE message types and actions
8. **Lock Lifecycle**: From creation to deletion

All flows are designed to:

- âœ… Prevent data conflicts
- âœ… Provide instant feedback
- âœ… Handle edge cases
- âœ… Never disrupt user input
- âœ… Maintain data consistency
